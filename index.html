<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>URL Rotator Dashboard</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <style>
    :root{
      --timer-offset-x: 10px;
      --timer-offset-y: 8px;
    }

    html, body {
      height:100%;
      margin:0;
      background:#000;
      overflow:hidden;
    }

    iframe {
      width:100%;
      height:100%;
      border:none;
      display:none;
    }

    #timer {
      position: fixed;
      right: var(--timer-offset-x);
      bottom: var(--timer-offset-y);
      color: #ff0000;
      font-family: monospace;
      font-weight: 800;
      font-size: 18px;
      letter-spacing: 0.5px;
      z-index: 9999;
      background: transparent;
      text-shadow: 0 0 3px rgba(0,0,0,0.85);
      user-select: none;
      pointer-events: none;
    }
  </style>
</head>

<body class="flex items-center justify-center">

  <iframe id="displayFrame"></iframe>
  <div id="timer">--:--</div>

  <script>
    /* ==========================
       URLS
       ========================== */
    const urls = [
      /* New Inbound Link */
      "https://app.powerbi.cn/groups/me/apps/62bc212e-1ec3-429c-8c08-8e2c214a56a5/reports/918228e5-1d03-47eb-8c4d-2248c5fae220/8548798fe5078024ae5d?ctid=a6c1b34e-d17f-48de-83b8-8e248b0f0360&bookmarkGuid=49fe60b0b6c23d050464",
      /* New Outbound Link */
      "https://app.powerbi.cn/groups/me/apps/62bc212e-1ec3-429c-8c08-8e2c214a56a5/reports/918228e5-1d03-47eb-8c4d-2248c5fae220/8548798fe5078024ae5d?ctid=a6c1b34e-d17f-48de-83b8-8e248b0f0360&bookmarkGuid=1daf9ae8cda95206eee1",
      /* OLD LINKS */
      /* WHO */
      "https://app.powerbi.cn/reportEmbed?reportId=26a1f08d-6580-426a-b893-765236fdf729&pageName=dc5ce38aea00c534582d&autoAuth=true&ctid=a6c1b34e-d17f-48de-83b8-8e248b0f0360",
      /* ABC Summary */
      "https://app.powerbi.cn/reportEmbed?reportId=26a1f08d-6580-426a-b893-765236fdf729&pageName=a83f37eabd0c65d901db&autoAuth=true&ctid=a6c1b34e-d17f-48de-83b8-8e248b0f0360",
      /* Inbound */
      "https://app.powerbi.cn/reportEmbed?reportId=db9bbc45-1908-45ca-9b86-a1a5d7884d05&pageName=df03977b21680c3e70d5&autoAuth=true&ctid=a6c1b34e-d17f-48de-83b8-8e248b0f0360",
      /* Outbound */
      "https://app.powerbi.cn/reportEmbed?reportId=db9bbc45-1908-45ca-9b86-a1a5d7884d05&pageName=18cfcbb8fcbc8256408c&autoAuth=true&ctid=a6c1b34e-d17f-48de-83b8-8e248b0f0360",
      /* CA Follow-up */
      "https://app.powerbi.cn/reportEmbed?reportId=346570b0-9473-4e16-b241-afc354ddb2f5&pageName=54d7e0cd8b699294007b&autoAuth=true&ctid=a6c1b34e-d17f-48de-83b8-8e248b0f0360"
    ];

    /* ==========================
       TEMPOS
       ========================== */
    const ONE_HALF_MIN = 1.5 * 60 * 1000;
    const ONE_MIN      = 1.0 * 60 * 1000;
    const HALF_MIN     = 0.5 * 60 * 1000;
    const FADE         = 300;

    let currentIndex = 0;
    let firstCycle = true;
    let countdownInterval;

    const $frame = $("#displayFrame");
    const $timer = $("#timer");

    /* =========================================================
       **NEGRITO** â€” CENÃRIO B: CONFIGURAÃ‡Ã•ES DE AUTO-RECOVERY
       ========================================================= */
    const HARD_RELOAD_INTERVAL = 30 * 60 * 1000; // **NEGRITO** reload preventivo (30 min)
    const IFRAME_LOAD_TIMEOUT  = 60 * 1000;      // **NEGRITO** timeout mÃ¡ximo do iframe (60s)

    /* =========================================================
       **NEGRITO** â€” HARD RELOAD PREVENTIVO (sessÃ£o Power BI)
       ========================================================= */
    setTimeout(() => {
      console.warn("ðŸ”„ Hard reload preventivo para evitar expiraÃ§Ã£o do Power BI");
      location.reload(true);
    }, HARD_RELOAD_INTERVAL);

    /* ==========================
       FUNÃ‡Ã•ES AUXILIARES
       ========================== */
    function delayFor(index) {
      if (index === 0) return ONE_HALF_MIN;
      return firstCycle ? ONE_MIN : HALF_MIN;
    }

    function startCountdown(ms) {
      clearInterval(countdownInterval);
      let remaining = Math.round(ms / 1000);
      updateTimerDisplay(remaining);

      countdownInterval = setInterval(() => {
        remaining--;
        if (remaining <= 0) {
          clearInterval(countdownInterval);
          remaining = 0;
        }
        updateTimerDisplay(remaining);
      }, 1000);
    }

    function updateTimerDisplay(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      $timer.text(
        `${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`
      );
    }

    /* =========================================================
       **NEGRITO** â€” LOAD URL COM WATCHDOG (CENÃRIO B)
       ========================================================= */
    function loadUrl(index) {
      const url = urls[index];
      console.log(`Loading [${index}] -> ${url}`);

      return new Promise(resolve => {
        let loaded = false;

        // **NEGRITO** Watchdog de carregamento
        const watchdog = setTimeout(() => {
          if (!loaded) {
            console.error("âš ï¸ Iframe nÃ£o carregou. Recarregando pÃ¡gina.");
            location.reload(true);
          }
        }, IFRAME_LOAD_TIMEOUT);

        $frame.fadeOut(FADE, function () {
          $frame.off("load");
          $frame.attr("src", url);

          $frame.on("load", function () {
            loaded = true;
            clearTimeout(watchdog);
            $frame.fadeIn(FADE, resolve);
          });
        });
      });
    }

    /* ==========================
       ROTATOR
       ========================== */
    async function rotate() {
      const wait = delayFor(currentIndex);
      startCountdown(wait);

      await loadUrl(currentIndex);

      currentIndex = (currentIndex + 1) % urls.length;
      if (currentIndex === 0 && firstCycle) firstCycle = false;

      setTimeout(rotate, wait);
    }

    /* =========================================================
       **NEGRITO** â€” WATCHDOG CONTÃNUO (iframe quebrado)
       ========================================================= */
    setInterval(() => {
      const src = $frame.attr("src");
      if (!src || src === "about:blank") {
        console.error("âš ï¸ Iframe invÃ¡lido detectado. Reload forÃ§ado.");
        location.reload(true);
      }
    }, 60 * 1000);

    $(document).ready(() => rotate());
  </script>
</body>
</html>


